<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Jeu 2048</title>
  <link rel="stylesheet" type="text/css" href="style.css" />
  
</head>

<body onload="init()">
  <div id="jeu">
    <div class="ligne">
      <div style="top:0px;left:0px;" class="case"></div>
      <div style="top:0px;left:102px;" class="case"></div>
      <div style="top:0px;left:204px;" class="case"></div>
      <div style="top:0px;left:306px;" class="case"></div>
    </div>
    <div class="ligne">
      <div style="top:102px;left:0px;" class="case"></div>
      <div style="top:102px;left:102px;" class="case"></div>
      <div style="top:102px;left:204px;" class="case"></div>
      <div style="top:102px;left:306px;" class="case"></div>
    </div>
    <div class="ligne">
      <div style="top:204px;left:0px;" class="case"></div>
      <div style="top:204px;left:102px;" class="case"></div>
      <div style="top:204px;left:204px;" class="case"></div>
      <div style="top:204px;left:306px;" class="case"></div>
    </div>
    <div class="ligne">
      <div style="top:306px;left:0px;" class="case"></div>
      <div style="top:306px;left:102px;" class="case"></div>
      <div style="top:306px;left:204px;" class="case"></div>
      <div style="top:306px;left:306px;" class="case"></div>
    </div>
  </div>
  
  <!-- <script type="text/javascript" src="script2.js"></script> -->
  
   <script type="text/javascript">
		 
		 class MaCase{
			 constructor(valeur,nouvelle){
				 this.valeur = valeur;
				 this.nouvelle = nouvelle;
			 }
		 }
		 
		 class Coordonnees{
			 constructor(abs,ord){
				 this.abs = abs;
				 this.ord = ord;
			 }
		 }
		 
		var grille = new Array(Array(MaCase));
		 
    function init(){
      
			for(var i = 0; i < 4; i++){
				var ligne = Array();
				for(var j = 0; j < 4; j++){
					ligne[j] = new MaCase("",false);
				}
				grille[i] = ligne;
			}
			
			window.addEventListener("keydown",actionClavier,false);
			
			insertionValeur(obtenirNouvelleValeur(), obtenirCaseVide());
			insertionValeur(obtenirNouvelleValeur(), obtenirCaseVide());
			
			afficherGrille();
			
    }
		 
		 function insertionValeur(valeur, coordonnee){
			 grille[coordonnee.abs][coordonnee.ord].valeur = valeur;
		 }
		 
		 function obtenirNouvelleValeur(){
			 var rand = Math.floor(Math.random()*10);
			 if(rand == 0)
				 return 4;
			 else return 2;
		 }
		 
		 function obtenirCaseVide(){
			 if(existsCaseVide(grille)){
				 var found = false;
				 while(!found){
					 var i = Math.floor(Math.random()*4);
					 var j = Math.floor(Math.random()*4);
					 if(grille[i][j].valeur == ""){
						 found = true;
						 return new Coordonnees(i,j);
					 }
				 }
			 }
		 }
		 
		 function existsCaseVide(){
			 var res = false;
			 grille.forEach(function(elem){
				 elem.forEach(function(elem2){
					 if(elem2.valeur == ""){
						 res = true;
					 }
				 });
			 });
			 return res;
		 }
		 
		 function actionClavier(e){
			 console.log("key pressed");
			 if(e.keyCode == 38)
				 deplacementVersHaut();
		 }
		 
		 function deplacementVersHaut(){
			 console.log("pressed up");
			 for(var i = 0; i < 4; i++){
					if(!estLigneVide(grille[i])){
						tasserVersHaut(i);
						fusionnerVersHaut();
						tasserVersHaut(i);
					}
				}
		 }
		 
		 function estLigneVide(ligne){
			 var res = true;
			 ligne.forEach(function(caseee){
				 if(caseee.valeur != "")
					 res = false;
			 });
			 return res;
		 }
		 
		 function tasserVersHaut(i){
			 for(var j = 0; j < 4; j++){
				 var done = false;
				 var currentPos = i;
				 if(i != 0){
					 while(!done){
						 if(grille[currentPos-1][j].valeur == ""){
							 grille[currentPos-1][j].valeur = grille[currentPos][j].valeur;
							 grille[currentPos][j].valeur = "";
							 console.log("moving value " + currentPos + ";" + j + " to " + currentPos-1 + ";" + j);
						 }
						 else{
							 done = true;
							 console.log("encountered filled case");
						 }
						 if(currentPos-1 <= 0){
							 done = true;
							 console.log("end of board");
						 }
						 currentPos--;
					 }
				 }
			 }
			 afficherGrille();
		 }
		 
		 function fusionnerVersHaut(){
			 for(var i = 0; i < 3; i++){
				 for(var j = 0; j < 4; j++){
					 if(grille[i+1][j].valeur == grille[i][j].valeur && grille[i+1][j].valeur != ""){
						 grille[i][j].valeur *= 2;
						 grille[i+1][j].valeur = "";
					 }
				 }
			 }
		 }
		 
		 function afficherGrille(){
			 var elements = document.body.querySelectorAll(".case");
			 for(var i = 0; i < 4; i++){
				 for(var j = 0; j < 4; j++){
					 elements[i*4+j].innerHTML = "<h1>" + grille[i][j].valeur + "</h1>";
					 if(grille[i][j].nouvelle)
						 elements[i*4+j].style.backgroundColor = "red";
				 }
			 }
		 }
     
  </script>
  
</body>
</html>